name: Run Tests

on:
  push:
    branches:
      - main
      - 'release/*'
  pull_request:
    branches:
      - main
      - 'release/*'

jobs:
  python-tests:
    runs-on: ubuntu-22.04
    env:
        HF_TOKEN: ${{ secrets.HF_RED_HAT_READ_ONLY }}
    steps:
        - uses: actions/setup-python@v5
          with:
            python-version: '3.10'
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0
            fetch-tags: true
        - name: Install system dependencies
          run: |-
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends g++ gcc make
        - name: Set Env
          run: pip3 install --upgrade pip setuptools
        - name: "‚öôÔ∏è Install dependencies"
          run: pip3 install .[dev,accelerate]
        - name: clean up
          run: |
            echo "cleaning up disk space as GHA runner has limited disk size."
            python3 -m pip cache purge
            sudo rm -rf /usr/local/.ghcup
            sudo rm -rf /opt/hostedtoolcache/CodeQL
            sudo rm -rf /usr/local/lib/android/sdk/ndk
            sudo rm -rf /usr/share/dotnet
            sudo rm -rf /opt/ghc
            sudo rm -rf /usr/local/share/boost
            if [[ "$(cat /etc/issue)" =~ Ubuntu ]]; then
              sudo apt-get clean
            fi
            df -h
          shell: bash
        - name: "üî¨ Running tests"
          run: make test
